(()=>{"use strict";var i=Class.extend({comm:null,cardsDiv:null,cardsGroup:null,filterDiv:null,cardFilter:null,pocketDiv:null,hideMerchantDiv:null,countDiv:null,infoDialog:null,questionDialog:null,currencyCount:null,ownedMin:0,hideMerchant:!1,init:function(i,t){var o=this;this.comm=new GempLotrCommunication("/gemp-lotr-server",o.processError),this.cardFilter=new CardFilter(t,(function(i,t,a,e){o.comm.getMerchant(i,o.ownedMin,t,a,e)}),(function(i){o.clearList(i)}),(function(i,t,a,e){o.addCardToList(i,t,a,e)}),(function(){o.finishList()})),this.cardFilter.setType("card"),this.cardFilter.setFilter("type:card"),this.cardsDiv=i,this.cardsGroup=new NormalCardGroup(this.cardsDiv,(function(i){return!0})),this.filterDiv=t,this.pocketDiv=$("<div class='pocket'></div>"),this.hideMerchantDiv=$("<div class='hideMerchant'><label for='hideMerchantCheck'>Hide merchant</label><input type='checkbox' id='hideMerchantCheck' value='hideMerchant'/></div>"),this.countDiv=$("<div class='countDiv'>Owned >= <select id='ownedMin'><option value='0'>0</option><option value='1'>1</option><option value='2'>2</option><option value='3'>3</option><option value='4'>4</option><option value='5'>5</option></select></div>"),this.filterDiv.append(this.pocketDiv),this.filterDiv.append(this.hideMerchantDiv),this.filterDiv.append(this.countDiv),$("#ownedMin").change((function(){o.ownedMin=$("#ownedMin option:selected").prop("value"),o.cardFilter.getCollection()})),$("#hideMerchantCheck").change((function(){o.hideMerchant=$("#hideMerchantCheck").prop("checked"),o.cardFilter.getCollection()})),this.infoDialog=$("<div></div>").dialog({autoOpen:!1,closeOnEscape:!0,resizable:!1,title:"Card information"}),this.questionDialog=$("<div></div>").dialog({autoOpen:!1,closeOnEscape:!0,resizable:!1,modal:!0,title:"Merchant operation"});var a={threshold:20,swipeUp:function(i){return o.infoDialog.prop({scrollTop:o.infoDialog.prop("scrollHeight")}),!1},swipeDown:function(i){return o.infoDialog.prop({scrollTop:0}),!1}};this.infoDialog.swipe(a),$("body").click((function(i){return o.clickCardFunction(i)})),$("body").mousedown((function(i){return o.dragStartCardFunction(i)})),$("body").mouseup((function(i){return o.dragStopCardFunction(i)})),this.cardFilter.getCollection()},dragCardData:null,dragStartX:null,dragStartY:null,successfulDrag:null,dragStartCardFunction:function(i){this.successfulDrag=!1;var t=$(i.target);if(t.hasClass("actionArea")){var o=t.closest(".card");if(1==i.which)return this.dragCardData=o.data("card"),this.dragStartX=i.clientX,this.dragStartY=i.clientY,!1}return!0},dragStopCardFunction:function(i){return null==this.dragCardData||(this.dragStartY-i.clientY>=20&&(this.displayCardInfo(this.dragCardData),this.successfulDrag=!0),this.dragCardData=null,this.dragStartX=null,this.dragStartY=null,!1)},clickCardFunction:function(i){var t=$(i.target);if(1==t.length&&"A"==t[0].tagName)return!0;if(!this.successfulDrag&&this.infoDialog.dialog("isOpen"))return this.infoDialog.dialog("close"),i.stopPropagation(),!1;if(t.hasClass("actionArea")){var o=t.closest(".card");return 1==i.which&&(this.successfulDrag||(i.shiftKey&&this.displayCardInfo(o.data("card")),i.stopPropagation())),!1}return!0},displayCardInfo:function(i){this.infoDialog.html(""),this.infoDialog.html("<div style='scroll: auto'></div>"),this.infoDialog.append(createFullCardDiv(i.imageUrl,i.foil,i.horizontal,i.isPack())),i.hasWikiInfo()&&this.infoDialog.append("<div><a href='"+i.getWikiLink()+"' target='_blank'>Wiki</a></div>");var t=$(window).width(),o=$(window).height();i.horizontal?this.infoDialog.dialog({width:Math.min(530,t),height:Math.min(425,o)}):this.infoDialog.dialog({width:Math.min(390,t),height:Math.min(565,o)}),this.infoDialog.dialog("open")},clearList:function(i){$(".card",this.cardsDiv).remove(),this.currencyCount=i.getAttribute("currency"),this.pocketDiv.html(formatPrice(this.currencyCount))},addCardToList:function(i,t,o,a){var e=i.getAttribute("buyPrice"),n=i.getAttribute("sellPrice"),r=i.getAttribute("tradeFoil"),l=new Array;l[0]={sizeChanged:function(i,t,o){$(".owned",i).css({position:"absolute",left:5,top:o-60,width:30,height:30}),$(".buyPrice",i).css({position:"absolute",left:40,top:o-80,width:t-45,height:25}),$(".sellPrice",i).css({position:"absolute",left:40,top:o-50,width:t-45,height:25}),$(".tradeFoil",i).css({position:"absolute",left:40,top:o-20,width:t-45,height:15})}};var s=null,c=null;if("pack"==t?(c=new Card(o,"merchant","collection","player"),(s=createCardDiv(c.imageUrl,null,!1,!0,!0,!1)).data("card",c),s.data("sizeListeners",l),this.cardsDiv.append(s)):"card"==t&&(c=new Card(o,"merchant","collection","player"),(s=createCardDiv(c.imageUrl,null,c.isFoil(),!0,!1,c.hasErrata())).data("card",c),s.data("sizeListeners",l),this.cardsDiv.append(s)),null!=s){var d=this;if(s.append("<div class='owned'>"+a+"</div>"),!this.hideMerchant){if(null!=e){var h=formatPrice(e),u=$("<div class='buyPrice'>Sell for<br/>"+h+"</div>").button();u.click((function(){d.displayMerchantAction(c,"Do you want to sell this item for "+h+"?",(function(){d.comm.sellItem(o,e,(function(){d.cardFilter.getCollection()}))}))})),s.append(u)}if(null!=n){var p=formatPrice(n),f=$("<div class='sellPrice'>Buy for<br/>"+p+"</div>").button();f.click((function(){d.displayMerchantAction(c,"Do you want to buy this item for "+p+"?",(function(){d.comm.buyItem(o,n,(function(){d.cardFilter.getCollection()}))}))})),parseInt(n)>parseInt(this.currencyCount)&&(f.button({disabled:!0}),f.css({color:"#ff0000"})),s.append(f)}if("true"==r){var g=$("<div class='tradeFoil'>Trade 4 for foil</div>").button();g.click((function(){d.displayMerchantAction(c,"Do you want to trade 4 of this card and 4G in currency for a foil version of the card?",(function(){d.comm.tradeInFoil(o,(function(){d.cardFilter.getCollection()}))}))})),s.append(g)}}}},displayMerchantAction:function(i,t,o){var a=this;this.questionDialog.html(""),this.questionDialog.html("<div style='scroll: auto'></div>");var e=$("<div style='float: left;'></div>");e.append(createFullCardDiv(i.imageUrl,i.foil,i.horizontal,i.isPack())),i.hasWikiInfo()&&e.append("<div><a href='"+i.getWikiLink()+"' target='_blank'>Wiki</a></div>"),this.questionDialog.append(e);var n=$("<div id='cardEffects'>"+t+"</div>");n.append("<br/>"),n.append($("<button>Yes</button>").button().click((function(){a.questionDialog.dialog("close"),o()}))),n.append($("<button>No</button>").button().click((function(){a.questionDialog.dialog("close")}))),this.questionDialog.append(n);var r=$(window).width(),l=$(window).height();i.horizontal?this.questionDialog.dialog({width:Math.min(730,r),height:Math.min(425,l)}):this.questionDialog.dialog({width:Math.min(590,r),height:Math.min(565,l)}),this.questionDialog.dialog("open")},finishList:function(){this.cardsGroup.layoutCards()},layoutUI:function(){var i=$(this.cardsDiv).width(),t=$(this.cardsDiv).height();this.cardsGroup.setBounds(0,0,i,t);var o=$(this.filterDiv).width(),a=$(this.filterDiv).height();this.cardFilter.layoutUi(0,0,o,a),this.pocketDiv.css({position:"absolute",left:o-60,top:35,width:60,height:18}),this.hideMerchantDiv.css({position:"absolute",left:o-100,top:a-38,width:100,height:18}),this.countDiv.css({position:"absolute",left:o-100,top:a-20,width:100,height:20})},processError:function(i,t,o){"abort"!=o&&alert("There was a problem during communication with server")}});function t(i){var t=$(window).width(),o=$(window).height();t<800&&(t=800),o<400&&(o=400),$("#cardFilter").css({position:"absolute",left:5,top:5,width:t-10,height:160}),$("#cardList").css({position:"absolute",left:5,top:170,width:t-10,height:o-160-15}),i.layoutUI()}$(document).ready((function(){var o=new i($("#cardList"),$("#cardFilter"));$(window).resize((function(){t(o)})),t(o)}))})();